<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Healed Elements Dashboard</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .element { margin-bottom: 10px; padding: 10px; border: 1px solid #ccc; }
        .approve-btn { background-color: #4CAF50; color: white; padding: 5px 10px; border: none; cursor: pointer; }
        .approve-btn:disabled { background-color: #ccc; cursor: not-allowed; }
    </style>
</head>
<body>
<h1>Healed Elements Dashboard</h1>
<div id="elements-list"></div>
<button id="approve-all-btn" class="approve-btn" disabled>Approve Selected</button>
        <script>
            const GITHUB_REPO = "healed-elements-dashboard";  // Update with your repo
            const GITHUB_OWNER = "saran-prakash-lab49";  // Update with your username/org
            const FILE_PATH = "data/locators.json"; // Path where locators are stored
            const GITHUB_TOKEN = "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"; // Use environment variable in production

            async function fetchData() {
                const response = await fetch('healed_elements.json');
                const data = await response.json();
                return data;
            }

            function renderData(data) {
                const elementsList = document.getElementById('elements-list');
                elementsList.innerHTML = '';

                data.healed_elements.forEach((element, index) => {
                    const elementDiv = document.createElement('div');
                    elementDiv.className = 'element';
                    elementDiv.innerHTML = `
                <p><strong>Element Name:</strong> ${element.name}</p>
                <p><strong>Original:</strong> ${element.original}</p>
                <input type="checkbox" class="approve-checkbox" data-name="${element.name}" data-original="${element.original}">
                <label> Approve </label>
              `;
                    elementsList.appendChild(elementDiv);
                });

                document.getElementById('approve-all-btn').disabled = false;
            }

            async function handleApproval() {
                const checkboxes = document.querySelectorAll('.approve-checkbox');
                const approvedLocators = {};

                checkboxes.forEach(checkbox => {
                    if (checkbox.checked) {
                        approvedLocators[checkbox.dataset.name] = checkbox.dataset.original;
                    }
                });

                if (Object.keys(approvedLocators).length > 0) {
                    alert(`Committing ${Object.keys(approvedLocators).length} approved locators...`);
                    await commitToGitHub(approvedLocators);
                } else {
                    alert('No elements selected for approval.');
                }
            }

            async function commitToGitHub(approvedLocators) {
                const apiUrl = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${FILE_PATH}`;

                // Fetch existing locators.json content
                const fileResponse = await fetch(apiUrl, {
                    headers: { Authorization: `token ${GITHUB_TOKEN}` }
                });

                let existingLocators = {};
                let sha = "";

                if (fileResponse.ok) {
                    const fileData = await fileResponse.json();
                    sha = fileData.sha;
                    existingLocators = JSON.parse(atob(fileData.content)).locators;
                }

                // Merge approved locators with existing ones
                const updatedLocators = { locators: { ...existingLocators, ...approvedLocators } };
                const updatedContent = btoa(JSON.stringify(updatedLocators, null, 2));

                // Prepare commit payload
                const commitData = {
                    message: "Approved healed locators",
                    content: updatedContent,
                    sha
                };

                // Commit to GitHub
                const commitResponse = await fetch(apiUrl, {
                    method: "PUT",
                    headers: {
                        "Authorization": `token ${GITHUB_TOKEN}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(commitData)
                });

                if (commitResponse.ok) {
                    alert("Successfully committed approved locators!");
                } else {
                    alert("Commit failed. Check console for details.");
                    console.error(await commitResponse.json());
                }
            }

            async function init() {
                const data = await fetchData();
                renderData(data);
                document.getElementById('approve-all-btn').addEventListener('click', handleApproval);
            }

            init();
        </script>


</body>
</html>
